# プロジェクト分析MCPサーバー - 技術選定書

## 1. 技術スタック概要

### 1.1 実行環境・言語
- **Node.js 18+**: MCPプロトコル標準対応
- **TypeScript 5.x**: 型安全性とコード品質確保
- **理由**: MCPサーバーの標準プラットフォーム、Claude Codeとの互換性、豊富なAST解析エコシステム

### 1.2 パッケージ管理
- **npm**: Node.js標準、MCPサンプルとの互換性重視
- **理由**: 追加設定不要、MCPコミュニティ標準

## 2. コード解析エンジン

### 2.1 AST (Abstract Syntax Tree) パーサー

#### 2.1.1 メインパーサー: Tree-sitter
```
tree-sitter: ^0.20.0
tree-sitter-javascript: ^0.21.0
tree-sitter-typescript: ^0.20.0
tree-sitter-python: ^0.20.0
tree-sitter-java: ^0.20.0
```

**選定理由**:
- **多言語対応**: 30+ 言語のパーサーが利用可能
- **高パフォーマンス**: Rust製、大規模コードベース対応
- **インクリメンタル解析**: 変更差分のみを再解析
- **エラー耐性**: 構文エラーがあってもパース継続

#### 2.1.2 言語別補完パーサー
```
@typescript-eslint/parser: ^6.0.0    // TypeScript詳細解析
acorn: ^8.10.0                       // JavaScript fallback
```

### 2.2 依存関係解析

#### 2.2.1 静的依存関係解析
```
madge: ^6.1.0                        // JavaScript/TypeScript依存関係グラフ
dependency-cruiser: ^13.0.0         // 高度な依存関係検証
```

#### 2.2.2 パッケージマネージャー解析
```
@npmcli/arborist: ^7.0.0            // npm dependency tree
lockfile-lint: ^4.12.0              // ロックファイル解析
```

**選定理由**:
- **精度**: 実際のモジュール解決ロジックを使用
- **速度**: キャッシュ機能で高速化
- **検証**: 循環依存や不整合を検出

## 3. メトリクス・分析ライブラリ

### 3.1 コード複雑度計算
```
typhonjs-escomplex: ^0.0.21         // JavaScript/TypeScript複雑度
```

**機能**:
- 循環的複雑度 (Cyclomatic Complexity)
- 認知的複雑度 (Cognitive Complexity)  
- 保守性指数 (Maintainability Index)
- Halstead メトリクス

### 3.2 コード品質分析
```
jscpd: ^3.5.0                       // コード重複検出
```

## 4. 可視化・レポート生成

### 4.1 図表生成
```
@mermaid-js/mermaid: ^10.6.0        // 主要な図表生成
plantuml-encoder: ^1.4.0            // PlantUML対応
```

**対応図表**:
- フローチャート
- クラス図
- コンポーネント図
- 依存関係図

### 4.2 データ可視化
```
d3: ^7.8.0                          // 高度なデータ可視化（将来拡張用）
```

## 5. ファイルシステム・プロジェクト解析

### 5.1 ファイル操作
```
fast-glob: ^3.3.0                   // 高速ファイル検索
ignore: ^5.2.0                      // .gitignore形式のファイル除外
```

### 5.2 プロジェクト構成解析
```
detect-package-manager: ^2.0.1      // パッケージマネージャー検出
find-up: ^6.3.0                     // 設定ファイル検索
```

## 6. MCP実装

### 6.1 MCPライブラリ
```
@modelcontextprotocol/sdk: ^1.0.0   // 公式MCPライブラリ
```

### 6.2 スキーマ検証
```
ajv: ^8.12.0                        // JSON Schema validation
```

## 7. 開発・テストツール

### 7.1 テストフレームワーク
```
jest: ^29.7.0                       // テストランナー
@types/jest: ^29.5.0                // Jest型定義
ts-jest: ^29.1.0                    // TypeScript対応
```

### 7.2 品質管理
```
eslint: ^8.50.0                     // コード品質チェック
@typescript-eslint/eslint-plugin: ^6.0.0
prettier: ^3.0.0                    // コードフォーマット
```

### 7.3 ビルド・開発支援
```
tsx: ^3.14.0                        // TypeScript実行環境
nodemon: ^3.0.0                     // 開発時自動再起動
```

## 8. ユーティリティライブラリ

### 8.1 データ処理
```
lodash: ^4.17.21                    // ユーティリティ関数
@types/lodash: ^4.14.0              // 型定義
```

### 8.2 ログ・デバッグ
```
winston: ^3.10.0                    // 構造化ログ
debug: ^4.3.0                       // デバッグ出力
```

## 9. パフォーマンス最適化

### 9.1 キャッシュ戦略
```
node-cache: ^5.1.2                 // メモリキャッシュ
lru-cache: ^10.0.0                 // LRUキャッシュ
```

### 9.2 並列処理
```
p-limit: ^4.0.0                    // 並行実行制御
worker_threads: [Node.js標準]       // CPU集約的タスクの並列化
```

## 10. 設定管理

### 10.1 設定ファイル管理
```
cosmiconfig: ^8.3.0                // 設定ファイル自動検出
```

## 11. 技術選定の判断基準

### 11.1 パフォーマンス要件への対応
- **大規模プロジェクト**: Tree-sitterの高速パース + Worker threads
- **メモリ効率**: ストリーミング処理 + LRUキャッシュ
- **キャッシュ戦略**: 分析結果の永続化で再実行高速化

### 11.2 拡張性への配慮
- **プラガブル設計**: パーサーとアナライザーの分離
- **設定駆動**: 言語固有のルールを外部設定で管理
- **モジュラー構成**: 機能単位での独立性確保

### 11.3 保守性の確保
- **型安全**: TypeScript + 厳格な型チェック
- **テスト容易**: 依存注入パターンでモック対応
- **エラーハンドリング**: 堅牢なエラーリカバリー機構

## 12. 技術的リスクと対策

### 12.1 パフォーマンスリスク
**リスク**: 大規模プロジェクトでのメモリ不足
**対策**: ストリーミング処理 + チャンク分割 + GC最適化

### 12.2 精度リスク
**リスク**: 動的な依存関係の見落とし
**対策**: 静的解析 + ランタイム情報の併用（package.jsonパース）

### 12.3 互換性リスク
**リスク**: 新言語・新フレームワークへの対応遅れ
**対策**: プラガブル設計 + パーサー追加の簡素化

## 13. 開発フェーズ別技術導入

### Phase 1 (MVP) - 基本機能
- Tree-sitter (JS/TS/Python)
- madge (依存関係)
- mermaid (基本図表)
- MCP SDK

### Phase 2 - 高度分析
- typhonjs-escomplex (メトリクス)
- jscpd (重複検出)
- d3 (高度可視化)

### Phase 3 - 拡張機能
- 追加言語パーサー
- カスタムアナライザー
- パフォーマンス最適化

---

**最終更新**: 2024-12-20
**技術責任者**: [開発中]
**次回見直し**: Phase 1 完了時